<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/connect.svg" type="image/svg+xml">
    <title>出行任务生成器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f6f8fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            flex-direction: column;
            padding: 20px;
        }

        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 95vw;
            max-width: 95vw;
            margin-bottom: 20px;
            overflow-x: auto;
            max-height: 85vh;
            overflow-y: auto;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            position: relative;
        }

        tbody {
            position: relative;
            z-index: 1;
        }

        th, td {
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
            min-width: 120px;
            max-width: 280px; /* 根据测试文本调整宽度 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 16px;
            color: #333;
        }

        th {
            background-color: #f0f0f0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border-bottom: 2px solid #ddd;
            height: 60px;
            min-height: 60px;
            font-weight: bold;
        }

        td {
            max-height: 50px;
            vertical-align: middle;
            display: table-cell;
        }

        /* 绿色列样式 - 前四列 */
        .green-column {
            background-color: #e8f5e9;
            min-width: 72px;
            width: 72px;
            color: #333;
        }

        th.green-column {
            background-color: #c8e6c9;
        }

        /* 蓝色列样式 - 中间五列 */
        .blue-column {
            background-color: #e3f2fd;
            color: #333;
        }

        th.blue-column {
            background-color: #bbdefb;
        }

        /* 黄色列样式 - 最后两列 */
        .yellow-column {
            background-color: #fff3cd;
            color: #333;
        }

        th.yellow-column {
            background-color: #ffeaa7;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        .task-btn {
            background-color: #28a745;
            font-size: 12px;
            padding: 4px 8px;
        }

        .task-btn:hover {
            background-color: #218838;
        }

        .register-btn {
            background-color: #ffc107;
            color: #212529;
            font-size: 12px;
            padding: 4px 8px;
        }

        .register-btn:hover {
            background-color: #e0a800;
        }

        .order-input {
            width: 100%;
            border: 1px solid #ccc;
            padding: 2px;
            font-size: 12px;
            box-sizing: border-box;
        }

        /* 渐隐提示样式 */
        .toast-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 14px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        .toast-error {
            background-color: #dc3545;
        }

        .toast-success {
            background-color: #28a745;
        }

        .toast-warning {
            background-color: #ffc107;
            color: #212529;
        }

        /* 不可编辑单元格点击复制样式 */
        .disabled-row {
            opacity: 0.8;
            font-weight: bold;
        }

        .disabled-row td[contenteditable="false"] {
            cursor: pointer;
        }

        .disabled-row td[contenteditable="false"]:hover {
            background-color: #f8f9fa !important;
            opacity: 1;
        }

        /* 不可编辑状态下各列的更淡背景色 */
        .disabled-row.green-column {
            background-color: #f1f8e9 !important;
        }

        .disabled-row.blue-column {
            background-color: #f3f9ff !important;
        }

        .disabled-row.yellow-column {
            background-color: #fffbf0 !important;
        }



        /* 折叠行样式 */
        .collapsed-row {
            height: 40px !important;
            font-size: 12px !important;
            opacity: 0.6;
            font-weight: normal !important;
        }

        .collapsed-row td {
            height: 40px !important;
            max-height: 40px !important;
            font-size: 12px !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <table id="dataTable">
            <thead>
                <tr>
                    <th class="green-column">资源ID</th>
                    <th class="green-column">出行场次</th>
                    <th class="green-column">出行日期</th>
                    <th class="green-column">出行人数</th>
                    <th class="blue-column">场次名</th>
                    <th class="blue-column">采购价格</th>
                    <th class="blue-column">任天堂时间</th>
                    <th class="blue-column">飞猪编码</th>
                    <th class="blue-column">预定链接</th>
                    <th class="yellow-column">操作</th>
                    <th class="yellow-column">采购订单号</th>
                </tr>
            </thead>
            <tbody>
                <!-- 初始空行 -->
                <tr>
                    <td contenteditable="true" class="green-column"></td>
                    <td contenteditable="true" class="green-column"></td>
                    <td contenteditable="true" class="green-column"></td>
                    <td contenteditable="true" class="green-column"></td>
                    <td contenteditable="true" class="blue-column"></td>
                    <td contenteditable="true" class="blue-column"></td>
                    <td contenteditable="true" class="blue-column"></td>
                    <td contenteditable="true" class="blue-column"></td>
                    <td contenteditable="true" class="blue-column"></td>
                    <td class="yellow-column"><button class="task-btn" onclick="generateTask(this)">任务生成</button></td>
                    <td class="yellow-column"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- 按钮容器 -->
    <div class="button-container">
        <button id="copyBtn">复制表格</button>
        <button id="clearBtn">清空</button>
        <button id="addRowBtn">添加行</button>
    </div>

    <script>
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadDataFromStorage();
            ensureEmptyRow();
            
            // 为现有单元格添加事件监听器
            const table = document.getElementById('dataTable');
            const cells = table.querySelectorAll('td[contenteditable="true"]');
            cells.forEach(cell => {
                addCellEventListeners(cell);
                handleCellContent(cell);
            });
        });



        // 计算字符串字节长度（中文字符按2字节计算）
        function getByteLength(str) {
            let byteLength = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charAt(i);
                if (char.match(/[\u4e00-\u9fa5]/)) {
                    byteLength += 2; // 中文字符2字节
                } else {
                    byteLength += 1; // 英文字符1字节
                }
            }
            return byteLength;
        }

        // 处理单元格内容长度限制
        function handleCellContent(cell) {
            const fullText = cell.textContent.trim();
            if (getByteLength(fullText) > 80) {
                // 使用title属性显示完整文本
                cell.setAttribute('title', fullText);
            } else {
                cell.removeAttribute('title');
            }
        }

        // 为单元格添加事件监听器
        function addCellEventListeners(cell) {
            // 输入事件监听器
            cell.addEventListener('input', function() {
                handleCellContent(this);
                saveDataToStorage();
            });
        }

        // 监听粘贴事件
        document.getElementById('dataTable').addEventListener('paste', function(e) {
            e.preventDefault();
            const clipboardData = e.clipboardData || window.clipboardData;
            const text = clipboardData.getData('text');
            const rows = text.split('\n');
            const table = e.target.closest('table');
            let startRow = e.target.parentElement.rowIndex;
            let startCol = e.target.cellIndex;

            rows.forEach((rowText, rowIndex) => {
                if (rowText.trim() === "") return;
                const cells = rowText.split('\t');
                let currentRow = table.rows[startRow + rowIndex];
                if (!currentRow) {
                    currentRow = addNewRow();
                }
                cells.forEach((cellText, cellIndex) => {
                    if (startCol + cellIndex < 9) { // 只粘贴到输入列（包括预定链接）
                        let currentCell = currentRow.cells[startCol + cellIndex];
                        if (currentCell && currentCell.contentEditable === "true") {
                            currentCell.textContent = cellText;
                            // 添加事件监听器
                            addCellEventListeners(currentCell);
                            // 处理内容长度限制
                            handleCellContent(currentCell);
                        }
                    }
                });
            });
            
            // 粘贴后检查是否需要添加新行
            setTimeout(() => {
                ensureEmptyRow();
                saveDataToStorage();
            }, 100);
        });

        // 显示渐隐提示
        function showToast(message, type = 'error') {
            const toast = document.createElement('div');
            toast.className = `toast-message toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 500);
            }, 3000);
        }

        // 生成任务
        function generateTask(button) {
            const row = button.closest('tr');
            const cells = row.cells;
            
            // 获取数据
            const resourceId = cells[0].textContent.trim();
            const session = cells[1].textContent.trim();
            const travelDate = cells[2].textContent.trim();
            const peopleCount = cells[3].textContent.trim();
            const sessionName = cells[4].textContent.trim();
            const price = cells[5].textContent.trim();
            const nintendoTime = cells[6].textContent.trim();
            const fliggyCode = cells[7].textContent.trim();
            const bookingLink = cells[8].textContent.trim();

            // 验证必填字段
            if (!travelDate || !peopleCount || !price) {
                showToast('请填写完整的出行日期、出行人数和采购价格！', 'error');
                return;
            }
            
            if (!nintendoTime && !sessionName) {
                showToast('任天堂时间和场次名不能同时为空！', 'error');
                return;
            }

            let taskText = '';
            const totalPrice = parseFloat(price) * parseInt(peopleCount);

            if (!nintendoTime || nintendoTime === '') {
                // 任天堂时间为空
                taskText = `左侧导航条 - VIP体验\n环球影城VIP体验\n${travelDate}\n${sessionName}\nVIP团队行程3小时\n\n${price}*${peopleCount}=${totalPrice}\n手机、邮箱和其他资料填自己的\n可以用花呗、信用卡`;
            } else {
                // 任天堂时间不为空
                taskText = `快速7项（指定场次）\n矿车精选\n\n${travelDate}\n任天堂${nintendoTime}后入园\n\n${price}*${peopleCount}=${totalPrice}\n手机、邮箱和其他资料填自己的\n可以用花呗、信用卡`;
            }

            // 复制到剪贴板
            navigator.clipboard.writeText(taskText).then(() => {
                showToast('任务内容已复制到剪贴板！', 'success');
                
                // 将该行设为不可编辑并添加点击复制功能
                for (let i = 0; i < 9; i++) { // 包括预定链接列
                    cells[i].contentEditable = "false";
                    cells[i].classList.add('disabled-row');
                    // 添加点击复制功能
                    cells[i].addEventListener('click', function() {
                        const content = this.textContent.trim();
                        if (content) {
                            navigator.clipboard.writeText(content).then(() => {
                                showToast(`已复制: ${content.length > 20 ? content.substring(0, 20) + '...' : content}`, 'success');
                            }).catch(err => {
                                console.error('复制失败:', err);
                                showToast('复制失败', 'error');
                            });
                        }
                    });
                }
                
                // 保存数据
                saveDataToStorage();
                
                // 检查是否需要添加新行
                setTimeout(() => {
                    ensureEmptyRow();
                }, 100);
                
                // 修改按钮文本和功能
                const productName = (!nintendoTime || nintendoTime === '') ? '三小时VIP' : 'Minecart & Selection';
                button.textContent = `【${productName}】已生成`;
                button.onclick = function() { restoreEditableState(this); };
                button.style.backgroundColor = '#6c757d';
                
                // 添加采购订单号输入框
                const orderCell = cells[10];
                const orderInput = document.createElement('input');
                orderInput.type = 'text';
                orderInput.className = 'order-input';
                orderInput.placeholder = '输入采购订单号';
                orderInput.addEventListener('paste', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡到表格的粘贴事件
                    setTimeout(() => {
                        this.value = this.value.trim().replace(/[\n\r]/g, '');
                        // 输入内容后显示登记按钮
                        if (this.value.trim()) {
                            showRegisterButton(this);
                        }
                    }, 0);
                });
                orderInput.addEventListener('input', function() {
                    if (this.value.trim()) {
                        showRegisterButton(this);
                    } else {
                        hideRegisterButton(this);
                    }
                    saveDataToStorage();
                });
                orderCell.innerHTML = '';
                orderCell.appendChild(orderInput);
            }).catch(err => {
                console.error('复制失败:', err);
                showToast('复制失败，请手动复制内容', 'error');
            });
        }

        // 登记采购表
        function registerPurchase(button) {
            const row = button.closest('tr');
            const cells = row.cells;
            
            // 获取采购订单号（现在在第10列）
            const orderInput = cells[10].querySelector('input');
            const orderNumber = orderInput ? orderInput.value.trim().replace(/\n/g, '').replace(/\r/g, '') : '';
            
            if (!orderNumber) {
                showToast('请先填写采购订单号！', 'warning');
                return;
            }
            
            // 获取其他数据
            const travelDate = cells[2].textContent.trim();
            const peopleCount = cells[3].textContent.trim();
            const price = cells[5].textContent.trim();
            const nintendoTime = cells[6].textContent.trim();
            
            const totalPrice = parseFloat(price) * parseInt(peopleCount);
            const productName = (!nintendoTime || nintendoTime === '') ? '三小时VIP' : 'Minecart & Selection';
            
            // 生成登记内容（使用制表符分隔）
            const registerText = `${orderNumber}\t${travelDate}\t${peopleCount}\t${totalPrice}\t¥15\t${price}\t飞猪\t胡勇\t胡勇\t${productName}`;
            
            // 复制到剪贴板
            navigator.clipboard.writeText(registerText).then(() => {
                showToast('登记内容已复制到剪贴板！可直接粘贴到Excel中', 'success');
                button.textContent = '已登记';
                button.disabled = true;
                button.style.backgroundColor = '#6c757d';
                
                // 折叠行并去除加粗样式
                collapseRegisteredRow(row);
                
                // 保存数据
                saveDataToStorage();
            }).catch(err => {
                console.error('复制失败:', err);
                showToast('复制失败，请手动复制内容', 'error');
            });
        }

        // 显示登记按钮
        function showRegisterButton(input) {
            const orderCell = input.parentElement;
            let registerBtn = orderCell.querySelector('.register-btn');
            if (!registerBtn) {
                registerBtn = document.createElement('button');
                registerBtn.className = 'register-btn';
                registerBtn.textContent = '登记采购表';
                registerBtn.onclick = function() { registerPurchase(this); };
                registerBtn.style.marginTop = '5px';
                registerBtn.style.display = 'block';
                orderCell.appendChild(registerBtn);
            }
        }
        
        // 隐藏登记按钮
        function hideRegisterButton(input) {
            const orderCell = input.parentElement;
            const registerBtn = orderCell.querySelector('.register-btn');
            if (registerBtn) {
                registerBtn.remove();
            }
        }

        // 添加新行
        function addNewRow() {
            const table = document.getElementById('dataTable').tBodies[0];
            const newRow = table.insertRow();
            
            // 添加输入列（包括预定链接）
            for (let i = 0; i < 9; i++) {
                const cell = newRow.insertCell();
                cell.contentEditable = "true";
                // 前四列使用green-column，中间五列使用blue-column
                if (i < 4) {
                    cell.className = "green-column";
                } else {
                    cell.className = "blue-column";
                }
                
                // 为每个可编辑单元格添加事件监听器
                addCellEventListeners(cell);
            }
            
            // 添加操作列
            const actionCell = newRow.insertCell();
            actionCell.className = "yellow-column";
            actionCell.innerHTML = '<button class="task-btn" onclick="generateTask(this)">任务生成</button>';
            
            // 添加采购订单号列
            const orderCell = newRow.insertCell();
            orderCell.className = "yellow-column";
            
            return newRow;
        }

        // 复制表格按钮功能
        document.getElementById('copyBtn').addEventListener('click', function() {
            let range = document.createRange();
            range.selectNode(document.getElementById('dataTable'));
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            showToast('表格内容已复制到剪贴板！', 'success');
        });

        // 恢复可编辑状态
        function restoreEditableState(button) {
            const row = button.closest('tr');
            const cells = row.cells;
            
            // 恢复可编辑状态并移除点击事件
            for (let i = 0; i < 9; i++) {
                cells[i].contentEditable = "true";
                cells[i].classList.remove('disabled-row');
                cells[i].style.fontWeight = 'normal';
                cells[i].style.opacity = '1';
                // 移除点击复制事件监听器
                const newCell = cells[i].cloneNode(true);
                cells[i].parentNode.replaceChild(newCell, cells[i]);
            }
            
            // 恢复按钮原始状态
            button.textContent = '任务生成';
            button.onclick = function() { generateTask(this); };
            button.style.backgroundColor = '#28a745';
            
            // 清空采购订单号
            cells[10].innerHTML = '';
            
            // 恢复行样式
            row.style.height = 'auto';
            for (let i = 0; i < row.cells.length; i++) {
                row.cells[i].style.padding = '12px';
                row.cells[i].style.fontSize = '16px';
                row.cells[i].style.opacity = '1';
            }
            
            // 保存数据
            saveDataToStorage();
        }

        // handleOrderPaste函数已被移除，粘贴处理现在直接在input元素的事件监听器中处理

        // 清空按钮功能
        document.getElementById('clearBtn').addEventListener('click', function() {
            const table = document.getElementById('dataTable').tBodies[0];
            while (table.rows.length > 1) {
                table.deleteRow(1);
            }
            const firstRow = table.rows[0];
            for (let i = 0; i < 9; i++) { // 包括预定链接列
                firstRow.cells[i].textContent = '';
                firstRow.cells[i].removeAttribute('title');
                firstRow.cells[i].contentEditable = "true";
                firstRow.cells[i].classList.remove('disabled-row');
                firstRow.cells[i].style.fontWeight = 'normal';
                firstRow.cells[i].style.opacity = '1';
            }
            firstRow.cells[9].innerHTML = '<button class="task-btn" onclick="generateTask(this)">任务生成</button>';
            firstRow.cells[10].innerHTML = '';
            
            // 重置行样式
            firstRow.style.height = 'auto';
            for (let i = 0; i < firstRow.cells.length; i++) {
                firstRow.cells[i].style.padding = '12px';
                firstRow.cells[i].style.fontSize = '16px';
            }
            
            // 清空本地存储
            localStorage.removeItem('travelTaskData');
        });

        // 添加行按钮功能
        document.getElementById('addRowBtn').addEventListener('click', function() {
            addNewRow();
            saveDataToStorage();
        });
        
        // 确保至少有一个空行
        function ensureEmptyRow() {
            const table = document.getElementById('dataTable').tBodies[0];
            const rows = table.rows;
            let hasEmptyRow = false;
            
            // 检查是否有空行
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                let isEmpty = true;
                
                // 检查前9列是否都为空
                for (let j = 0; j < 9; j++) {
                    if (row.cells[j] && row.cells[j].textContent.trim() !== '') {
                        isEmpty = false;
                        break;
                    }
                }
                
                if (isEmpty) {
                    hasEmptyRow = true;
                    break;
                }
            }
            
            // 如果没有空行，添加一个
            if (!hasEmptyRow) {
                addNewRow();
            }
        }
        
        // 保存数据到本地存储
        function saveDataToStorage() {
            const table = document.getElementById('dataTable').tBodies[0];
            const rows = Array.from(table.rows);
            const data = [];
            
            rows.forEach((row, index) => {
                const rowData = {
                    cells: [],
                    isGenerated: false,
                    isRegistered: false,
                    orderNumber: '',
                    productName: '',
                    timestamp: Date.now() // 添加时间戳
                };
                
                // 保存前9列的数据
                for (let i = 0; i < 9; i++) {
                    rowData.cells.push(row.cells[i].textContent.trim());
                }
                
                // 检查是否已生成任务
                const taskBtn = row.cells[9].querySelector('button');
                if (taskBtn && taskBtn.textContent.includes('已生成')) {
                    rowData.isGenerated = true;
                    rowData.productName = taskBtn.textContent.match(/【(.+)】/)[1];
                }
                
                // 检查采购订单号和登记状态
                const orderInput = row.cells[10].querySelector('input');
                if (orderInput) {
                    rowData.orderNumber = orderInput.value.trim();
                }
                
                const registerBtn = row.cells[10].querySelector('button');
                if (registerBtn && registerBtn.textContent === '已登记') {
                    rowData.isRegistered = true;
                }
                
                // 只保存有数据的行
                if (rowData.cells.some(cell => cell !== '')) {
                    data.push(rowData);
                }
            });
            
            // 获取现有数据并合并
            let existingData = [];
            try {
                const stored = localStorage.getItem('travelTaskData');
                if (stored) {
                    existingData = JSON.parse(stored);
                }
            } catch (e) {
                console.error('读取本地数据失败:', e);
            }
            
            // 合并数据并按时间戳排序，保留最新的10条
            const allData = [...existingData, ...data];
            const sortedData = allData.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            const latestData = sortedData.slice(0, 10);
            
            localStorage.setItem('travelTaskData', JSON.stringify(latestData));
        }
        
        // 从localStorage加载数据
        function loadDataFromStorage() {
            const savedData = localStorage.getItem('travelTaskData');
            if (!savedData) return;
            
            try {
                const data = JSON.parse(savedData);
                const table = document.getElementById('dataTable').tBodies[0];
                
                // 清空现有行
                while (table.rows.length > 0) {
                    table.deleteRow(0);
                }
                
                // 重建数据行
                data.forEach(rowData => {
                    const newRow = addNewRow();
                    const cells = newRow.cells;
                    
                    // 填充数据
                    for (let i = 0; i < 9; i++) {
                        cells[i].textContent = rowData.cells[i] || '';
                        // 添加事件监听器
                        addCellEventListeners(cells[i]);
                        // 处理内容长度限制
                        handleCellContent(cells[i]);
                    }
                    
                    // 如果已生成任务，恢复状态
                    if (rowData.isGenerated) {
                        // 模拟任务生成状态
                        for (let i = 0; i < 9; i++) {
                            cells[i].contentEditable = "false";
                            cells[i].classList.add('disabled-row');
                            // 添加点击复制功能
                            cells[i].addEventListener('click', function() {
                                const content = this.textContent.trim();
                                if (content) {
                                    navigator.clipboard.writeText(content).then(() => {
                                        showToast(`已复制: ${content.length > 20 ? content.substring(0, 20) + '...' : content}`, 'success');
                                    }).catch(err => {
                                        console.error('复制失败:', err);
                                        showToast('复制失败', 'error');
                                    });
                                }
                            });
                        }
                        
                        const nintendoTime = cells[6].textContent.trim();
                        const productName = (!nintendoTime || nintendoTime === '') ? '三小时VIP' : 'Minecart & Selection';
                        const taskBtn = cells[9].querySelector('button');
                        taskBtn.textContent = `【${productName}】已生成`;
                        taskBtn.onclick = function() { restoreEditableState(this); };
                        taskBtn.style.backgroundColor = '#6c757d';
                        
                        // 添加采购订单号输入框
                        const orderInput = document.createElement('input');
                        orderInput.type = 'text';
                        orderInput.className = 'order-input';
                        orderInput.placeholder = '输入采购订单号';
                        orderInput.value = rowData.orderNumber;
                        orderInput.addEventListener('paste', function(e) {
                            e.stopPropagation();
                            setTimeout(() => {
                                this.value = this.value.trim().replace(/[\n\r]/g, '');
                            }, 0);
                        });
                        orderInput.addEventListener('input', function() {
                            if (this.value.trim()) {
                                showRegisterButton(this);
                            } else {
                                hideRegisterButton(this);
                            }
                            saveDataToStorage();
                        });
                        cells[10].innerHTML = '';
                        cells[10].appendChild(orderInput);
                        
                        if (rowData.orderNumber) {
                            showRegisterButton(orderInput);
                        }
                        
                        // 如果已登记，恢复登记状态
                        if (rowData.isRegistered) {
                            // 确保登记按钮存在
                            if (rowData.orderNumber) {
                                showRegisterButton(orderInput);
                            }
                            const registerBtn = cells[10].querySelector('.register-btn');
                            if (registerBtn) {
                                registerBtn.textContent = '已登记';
                                registerBtn.disabled = true;
                                registerBtn.style.backgroundColor = '#6c757d';
                            }
                            collapseRegisteredRow(newRow);
                        }
                    }
                });
                
            } catch (error) {
                console.error('加载数据失败:', error);
            }
        }
        
        // 折叠已登记的行
        function collapseRegisteredRow(row) {
            // 去除加粗样式
            for (let i = 0; i < 9; i++) {
                row.cells[i].style.fontWeight = 'normal';
            }
            
            // 设置行高为最小值
            row.style.height = '40px';
            
            // 设置单元格样式
            for (let i = 0; i < row.cells.length; i++) {
                row.cells[i].style.padding = '4px 8px';
                row.cells[i].style.fontSize = '12px';
                row.cells[i].style.opacity = '0.6';
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 为现有的可编辑单元格添加事件监听器
            const table = document.getElementById('dataTable');
            const cells = table.querySelectorAll('td[contenteditable="true"]');
            cells.forEach(cell => {
                addCellEventListeners(cell);
            });
            
            // 加载保存的数据
            loadDataFromStorage();
            
            // 确保至少有一个空行
            ensureEmptyRow();
        });
    </script>
</body>
</html>
